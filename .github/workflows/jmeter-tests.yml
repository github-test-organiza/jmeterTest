name: JMeter Scheduled Tests

on:
  schedule:
    - cron: '0 3 * * *'  # every day 3 AM UTC
  workflow_dispatch:  # enable manual execution

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code (branch principal)
        uses: actions/checkout@v4

      - name: üì¶ JMeter Install
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre-headless
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
          tar -xzf apache-jmeter-5.5.tgz
          echo "üîç Verifying files..."
          ls -l
          ls -l apache-jmeter-5.5/bin

      - name: üìÇ Create folders for JMeter
        run: |
          mkdir -p jmeter/results
          mkdir -p jmeter/global-report

      - name: ‚úçÔ∏è Preprocess JMX file
        env:
          PERIOD: ${{ vars.PERIOD }}
          THREADS: ${{ vars.THREADS }}
        run: |
          sed -i "s/\${THREADS}/$THREADS/g" jmeter/test_plan.jmx
          sed -i "s/\${PERIOD}/$PERIOD/g" jmeter/test_plan.jmx

      - name: üöÄ Run JMeter Test HTML
        run: |
          apache-jmeter-5.5/bin/jmeter -n -t jmeter/test_plan.jmx \
            -l jmeter/results/results.jtl -e -o jmeter/global-report

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Merge previous reports from gh-pages branch
        run: |
          rm -rf reports
          mkdir -p reports
          if [ -d gh-pages ]; then
            cp -R gh-pages/* reports/
          fi

      - name: Create folder for current report
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p reports
          cp -R jmeter/global-report reports/$TIMESTAMP
          echo "Report generated in: reports/$TIMESTAMP"

      - name: üìù Generate advanced report index
        run: |
          cat << 'EOF' > reports/index.html
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>JMeter Reports Dashboard</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              body {
                background-color: #f8f9fa;
                padding-top: 20px;
              }
              .report-card {
                transition: transform 0.2s ease-in-out;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              }
              .report-card:hover {
                transform: scale(1.03);
              }
              .card-title {
                font-size: 1.25rem;
              }
              .footer {
                margin-top: 50px;
                text-align: center;
                font-size: 0.9rem;
                color: #6c757d;
              }
            </style>
          </head>
          <body>
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
              <div class="container">
                <a class="navbar-brand" href="#">JMeter Reports Dashboard</a>
              </div>
            </nav>
            <div class="container">
              <div class="row">
          EOF
          for dir in reports/*/ ; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            if [ "$dirname" != "index.html" ]; then
              echo "          <div class=\"col-md-4 mb-4\">" >> reports/index.html
              echo "            <div class=\"card report-card\">" >> reports/index.html
              echo "              <div class=\"card-body\">" >> reports/index.html
              echo "                <h5 class=\"card-title\">$dirname</h5>" >> reports/index.html
              echo "                <p class=\"card-text\">Reporte generado el $dirname. Haz clic para ver el detalle.</p>" >> reports/index.html
              echo "                <a href=\"${dirname}/\" class=\"btn btn-primary\">Ver Reporte</a>" >> reports/index.html
              echo "              </div>" >> reports/index.html
              echo "            </div>" >> reports/index.html
              echo "          </div>" >> reports/index.html
            fi
          done
          cat << 'EOF' >> reports/index.html
              </div>
            </div>
            <footer class="footer">
              <div class="container">
                <p>&copy; $(date +%Y) JMeter Reports Dashboard. Todos los derechos reservados.</p>
              </div>
            </footer>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
          </body>
          </html>
          EOF

      - name: üåê Publish reports in GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
