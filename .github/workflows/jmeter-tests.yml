name: JMeter Scheduled Tests

on:
  schedule:
    - cron: '0 3 * * *'  # every day 3 AM UTC
  workflow_dispatch:  # enable manual execution

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code (branch principal)
        uses: actions/checkout@v4

      - name: üì¶ JMeter Install
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre-headless
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
          tar -xzf apache-jmeter-5.5.tgz
          echo "üîç Verifying files..."
          ls -l
          ls -l apache-jmeter-5.5/bin

      - name: üìÇ Create folders for JMeter
        run: |
          mkdir -p jmeter/results
          mkdir -p jmeter/global-report

      - name: üöÄ Run JMeter Test HTML
        run: |
          apache-jmeter-5.5/bin/jmeter -n -t jmeter/test_plan.jmx \
          -Jthreads=$THREADS \
          -Jrampup=$PERIOD \
          -l jmeter/results/results.jtl -e -o jmeter/global-report
        env:
          # GROUP_NAME: ${{ secrets.GROUP_NAME }}
          PERIOD: ${{ variables.PERIOD }}
          THREADS: ${{ variables.THREADS }}

      # Clonamos la rama gh-pages en un directorio aparte
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # Copiamos el contenido previo (los reportes antiguos) desde gh-pages a nuestro directorio 'reports'
      - name: Copy previous reports from gh-pages
        run: |
          if [ -d gh-pages/reports ]; then
            mkdir -p reports
            cp -R gh-pages/reports/* reports/
          fi

      # Creamos la carpeta para el reporte actual (con timestamp) y copiamos el reporte generado
      - name: Create folder for current report
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p reports
          cp -R jmeter/global-report reports/$TIMESTAMP
          echo "Report generated in: reports/$TIMESTAMP"

      # Generamos un √≠ndice que liste todos los subdirectorios (reportes) en 'reports'
      - name: Generate report index
        run: |
          echo "<html><head><title>JMeter Reports</title></head><body>" > reports/index.html
          echo "<h1>JMeter Reports</h1><ul>" >> reports/index.html
          for dir in reports/*/ ; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            if [ "$dirname" != "index.html" ]; then
              echo "<li><a href=\"${dirname}/\">${dirname}</a></li>" >> reports/index.html
            fi
          done
          echo "</ul></body></html>" >> reports/index.html

      # Publicamos todo el contenido del directorio 'reports'
      - name: üåê Publish reports in GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
