name: JMeter Scheduled Tests

on:
  schedule:
    - cron: '0 3 * * *'  # every day 3 AM UTC
  workflow_dispatch:  # enable manual execution

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ JMeter Install
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre-headless
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
          tar -xzf apache-jmeter-5.5.tgz
          echo "ğŸ” Verifying files..."
          ls -l
          ls -l apache-jmeter-5.5/bin

      - name: ğŸ“‚ Creating folders
        run: |
          mkdir -p jmeter/results
          mkdir -p jmeter/global-report

      - name: ğŸš€  JMeter Execution Test HTML
        run: |
          apache-jmeter-5.5/bin/jmeter -n -t jmeter/test_plan.jmx -l jmeter/results/results.jtl -e -o jmeter/global-report

      - name: â¬‡ï¸ gh-pages Clone
        run: |
          git clone --branch gh-pages https://github.com/${{ github.repository }} gh-pages-temp || echo "No exist gh-pages yet"
          if [ -d gh-pages-temp/reports ]; then
            cp -R gh-pages-temp/reports ./reports
          fi

      - name: ğŸ“ Creating folder for reports
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p reports
          cp -R jmeter/global-report reports/$TIMESTAMP
          echo "Report generate in : reports/$TIMESTAMP"

      - name: ğŸ“ Generate report index
        run: |
          echo "<html><head><title>JMeter Reports</title></head><body>" > reports/index.html
          echo "<h1>JMeter Report</h1><ul>" >> reports/index.html
          for dir in reports/*/ ; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            if [ "$dirname" != "index.html" ]; then
              echo "<li><a href=\"${dirname}/\">${dirname}</a></li>" >> reports/index.html
            fi
          done
          echo "</ul></body></html>" >> reports/index.html
      
      - name: ğŸŒ Publish reports in GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
