name: JMeter Scheduled Tests

on:
  schedule:
    - cron: '0 3 * * *'  # every day 3 AM UTC
  workflow_dispatch:  # enable manual execution

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code (branch principal)
        uses: actions/checkout@v4

      - name: ğŸ“¦ JMeter Install
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre-headless
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
          tar -xzf apache-jmeter-5.5.tgz
          echo "ğŸ” Verifying files..."
          ls -l
          ls -l apache-jmeter-5.5/bin

      - name: ğŸ“‚ Create folders for JMeter
        run: |
          mkdir -p jmeter/results
          mkdir -p jmeter/global-report

      - name: ğŸš€ Run JMeter Test HTML
        run: |
          apache-jmeter-5.5/bin/jmeter -n -t jmeter/test_plan.jmx -l jmeter/results/results.jtl -e -o jmeter/global-report

      # Clonamos la rama gh-pages en un directorio aparte
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # Copiamos el contenido previo (los reportes antiguos) desde gh-pages a nuestro directorio 'reports'
      - name: Copy previous reports from gh-pages
        run: |
          if [ -d gh-pages/reports ]; then
            mkdir -p reports
            cp -R gh-pages/reports/* reports/
          fi

      # Creamos la carpeta para el reporte actual (con timestamp) y copiamos el reporte generado
      - name: Create folder for current report
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p reports
          cp -R jmeter/global-report reports/$TIMESTAMP
          echo "Report generated in: reports/$TIMESTAMP"

      # Generamos un Ã­ndice que liste todos los subdirectorios (reportes) en 'reports'
      - name: ğŸ“ Generate report index with improved design
        run: |
          cat << 'EOF' > reports/index.html
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>JMeter Reports</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              body { margin: 20px; }
              h1 { margin-bottom: 20px; }
              ul { list-style-type: none; padding: 0; }
              li { margin-bottom: 10px; }
              a { text-decoration: none; color: #0d6efd; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1 class="display-4">JMeter Reports</h1>
              <ul>
          EOF

            for dir in reports/*/ ; do
              [ -d "$dir" ] || continue
              dirname=$(basename "$dir")
              if [ "$dirname" != "index.html" ]; then
                echo "<li><a href=\"${dirname}/\">${dirname}</a></li>" >> reports/index.html
              fi
            done

          cat << 'EOF' >> reports/index.html
              </ul>
            </div>
          </body>
          </html>
          EOF


      # Publicamos todo el contenido del directorio 'reports'
      - name: ğŸŒ Publish reports in GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
